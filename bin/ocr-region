#! /usr/bin/env cached-nix-shell
--[[
#! nix-shell -i lua -p lua tesseract imagemagick maim
]]

local io = require("io")
local os = require("os")

local function selectOption(options)
    for i, option in ipairs(options) do
        print(i .. ": " .. option)
    end
    io.write("Select an option: ")

    local choice = tonumber(io.read())
    while choice == nil or choice < 1 or choice > #options do
        io.write("Invalid selection. Please choose a valid option: ")
        choice = tonumber(io.read())
    end

    return options[choice]
end

-- Ask the user to select a tesseract language
local tesseract_lang = selectOption({ "eng", "swe", "ara", "chi_sim", "equ" })
print(string.format("Selected language: %s", tesseract_lang))

-- Create a temporary file for the screenshot
local scr_img = os.tmpname() .. ".png"

-- Take a screenshot with maim
os.execute("maim -s " .. scr_img .. " -q 100")

-- Increasing image quality
os.execute("mogrify -modulate 100,0 -resize 400% " .. scr_img)

-- Run tesseract on the screenshot
os.execute(
    "tesseract "
        .. scr_img
        .. " "
        .. scr_img
        .. " -l "
        .. tesseract_lang
        .. " quiet"
)

-- Read the OCR output from the .txt file generated by tesseract
local ocr_output = io.open(scr_img .. ".txt"):read("*all")

-- Echo the output of Tesseract OCR detection
io.write(ocr_output)

-- Send the OCR output to clipboard using Clipboard
os.execute("echo '" .. ocr_output .. "' | cb copy")

-- Cleaning up
os.remove(scr_img)
os.remove(scr_img .. ".txt")
