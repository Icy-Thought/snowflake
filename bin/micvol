#!/usr/bin/env cached-nix-shell
#! nix-shell -i python3 -p pamixer

import argparse
import subprocess
import time

parser = argparse.ArgumentParser(
    prog="Microphone Volume Control",
    description="A simple script to help control the internal microphone levels of your hardware device(s)!",
    epilog="Please, try again.",
)

subparser = parser.add_subparsers(dest="command")

increase = subparser.add_parser("increase")
decrease = subparser.add_parser("decrease")
mute = subparser.add_parser("toggle-mute")
status = subparser.add_parser("status")

increase.add_argument(
    "-l", "--level",
    type=int,
    default=5,
    help="Increase microphone levels by +x%. (default: +%(default)%)",
)

decrease.add_argument(
    "-l", "--level",
    type=int,
    default=5,
    help="Decrease microphone levels by -x%. (default: -%(default)%)",
)

mute.add_argument(
    "-t", "--toggle-mute",
    action="store_true",
    help="Toggle mute for device microphone. (default: False)",
)


args = parser.parse_args()

mute_status = subprocess.run(
    ["pamixer", "--default-source", "--get-mute"],
    stdout=subprocess.PIPE,
    universal_newlines=True,
)
get_mute = mute_status.stdout.strip()

get_micVol = subprocess.run(
    ["pamixer", "--default-source", "--get-volume"],
    stdout=subprocess.PIPE,
    universal_newlines=True,
)
micVol_level = get_micVol.stdout.strip()


def notify(message):
    subprocess.Popen(
        [
            "notify-send", message,
            "-t", "500",
            "-h", "string:synchronous:volume",
            "-h", "int:value:" + micVol_level,
            "-u", "low",
        ]
    )
    return


def notify_status(msg: str):
    ICONS = [" ", " "]
    if msg == "mute":
        notify(ICONS[0] + "Muted Microphone!")
    elif msg == "volume":
        notify(ICONS[1] + "Microphone Volume: " + micVol_level + "%")
    else:
        return


def pamixer(param: str, lvl: str):
    subprocess.run(["pamixer", "--default-source", param, lvl])


def change_micVol_level():
    if args.command == "toggle-mute" and get_mute == "false":
        pamixer("-t", "")
        notify_status("mute")
    elif args.command == "toggle-mute" and get_mute == "true":
        pamixer("-t", "")
        notify_status("volume")
    elif args.command != "toggle-mute" and get_mute == "true":
        pamixer("-t", "")
        notify_status("volume")
    elif args.command == "increase":
        pamixer("-i", str(args.level))
        notify_status("volume")
    elif args.command == "decrease":
        pamixer("-d", str(args.level))
        notify_status("volume")
    else:
        return


change_micVol_level()


def micVol_status():
    if args.command == "status":
        while True:
            print(" " + micVol_level + "%")
            time.sleep(60)
    else:
        return


micVol_status()
